---
title: 'STA304 Final Report: Causal Inference Analysis on the Factors that May Affect
  Life Expectancy'
author: "Qihui Huang, 1004932905"
date: "12/7/2020"
output:
  html_document:
    df_print: paged
  pdf_document:
    latex_engine: xelatex
bibliography: reference.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(readr)
library(tidyverse)
library(skimr)
library(arm)
library(broom)
library(huxtable)
library(dplyr)
```

#Abstruct

#Key Words

Propensity Score, Causal Inference, Life expectancy, Immunization, Observational study, WHO

# Introduction

Life expectancy has always been an intriguing topic throughout several centuries, and 
there have been lots of studies conducted in the past on factors affecting life expectancy, like personal income, morality, alcohol consumption, GDP and health care insurance etc. During COVID-19 pandemic, topics like immunization and vaccination have become more and more popular. As COVID vaccines are still in approval process, people all around the world are expecting the release of the vaccines that would lower down the number cases and prolong life. Therefore it is non-negligible when we consider the factors that may impose effects on life expectancy. This motivates us to explore the casual inference between the life expectancy, and build a regression model based off multiple factors considering data in a decade period all around the world. [@citeDataset]

The analysis will focus on casual inference of factor immunization rate/number of citizens get vaccinated and life expectancy varies based off this factor. Major types of vaccines like Hepatitis B, Polio and Diphtheria will be combined, which means they are all be considered as general vaccine instead of differentiating them. Propensity score matching is used here to discern whether individuals get vaccinated already and whether individuals die before the average age of population. Other factors like countries economic condition, mortality and average education level will also be taken into consideration when conduct the multiple linear regression analysis.


# Methodology

## Data Description and Data Cleaning

The raw dataset sourced from the website @Kaggle has been modified by performing some basic data cleaning steps, including mutating and choosing specific variables. There are in total 22 variables including both categorical and numerical, and these are all potential factors that may impose different levels of effect on life expectancy; 13 of them have been chosen and put into a new cleaned dataset, like *life expectancy*, *country*, *BMI* and different types of vaccines etc.. These variables I chose are more representative and clean compared to other factors, and will be easily manipulated in the later analysis. For convenience's sake, especially in matching propensity scores, a new binary variable named *vaccine_coverage_over_ave* been created, measuring whether a country’s immunization coverage exceeds the world’s average or not. This is simply done by adding all general vaccines coverage rate together for each country, then compared each of them with the mean of the world vaccine coverage. In this case, 1 represents the country has met the world’s average immunization coverage, and 0 represents the country has not met the criteria here yet. Moreover, renaming variables and removing rows with $NAs$ or invalid numbers are done in this part as well.

A glimpse of cleaned dataset:

```{r,echo=FALSE,message=FALSE}
#rename and select predictors/variables for later usage.
raw_data <- read_csv("life_expectancy.csv")
cleaned_data <- raw_data %>%
  rename(country = `Country`) %>%
  rename(status = `Status`) %>%
  rename(population = `Population`) %>%
  rename(life_expectancy = `Life expectancy`) %>%
  rename(total_expenditure = `Total expenditure`) %>%
  rename(Hepatitis_B = `Hepatitis B`) %>%
  rename(HIV_AIDS = `HIV/AIDS`) %>%
  rename(healthcoverage_percent = `percentage expenditure`) %>%
  rename(adult_mortality = `Adult Mortality`) %>%
  filter(Schooling != 0.0) %>%
  dplyr :: select(country, status, life_expectancy, adult_mortality, Alcohol, healthcoverage_percent, Hepatitis_B, BMI, Polio, total_expenditure, Diphtheria, GDP, Schooling)

cleaned_data <- na.omit(cleaned_data)

# Mutate a binary treatment immunization coverage
cleaned_data <- cleaned_data %>%
  mutate(vaccine_total = Polio+Diphtheria+Hepatitis_B) %>%
  mutate(vaccine_coverage_over_ave = ifelse(vaccine_total >= mean(vaccine_total), 1, 0))

knitr::kable(cleaned_data[1:20, ])
```

## Model

```{r,echo=FALSE, message=FALSE}
attach(cleaned_data)
propensity_score <- glm(vaccine_coverage_over_ave ~ country+status+adult_mortality+Alcohol+total_expenditure+GDP+BMI+Schooling,
                        family = binomial,
                        data = cleaned_data)

# add forecast to our dataset
cleaned_data <- augment(propensity_score,
                        data = cleaned_data,
                        type.predict = "response") %>%
  dplyr::select(-.resid, -.std.resid, -.hat, -.sigma, -.cooksd)

cleaned_data <- cleaned_data %>%
  arrange(.fitted, vaccine_coverage_over_ave)
```





# References


